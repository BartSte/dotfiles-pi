#!/usr/bin/env bash
set -euo pipefail

# Interactive auth step: inject secrets into ~/.clawdbot/clawdbot.json
# Assumes rbw is unlocked. Secrets are read from rbw entries.

CONFIG="$HOME/.clawdbot/clawdbot.json"
TEMPLATE="$HOME/moltbot/clawdbot.json.template"

mkdir -p "$HOME/.clawdbot"

# Seed config from template if missing
if [[ ! -f "$CONFIG" ]]; then
  cp "$TEMPLATE" "$CONFIG"
fi

# Read secrets (override by env if set)
TELEGRAM_BOT_TOKEN="${TELEGRAM_BOT_TOKEN:-}"
BRAVE_API_KEY="${BRAVE_API_KEY:-}"
GATEWAY_TOKEN="${CLAWDBOT_GATEWAY_TOKEN:-}"

if [[ -z "$TELEGRAM_BOT_TOKEN" ]]; then
  TELEGRAM_BOT_TOKEN=$(rbw get telegram_bot_token 2>/dev/null | tr -d '\n' || true)
fi
if [[ -z "$BRAVE_API_KEY" ]]; then
  BRAVE_API_KEY=$(rbw get brave_search_api_token 2>/dev/null | tr -d '\n' || true)
fi
if [[ -z "$GATEWAY_TOKEN" ]]; then
  GATEWAY_TOKEN=$(rbw get clawdbot_gateway_token 2>/dev/null | tr -d '\n' || true)
fi

python3 - <<'PY'
import json, os
from pathlib import Path

path = Path(os.environ['CONFIG'])
obj = json.loads(path.read_text())

def set_key(d, path, val):
    if not val:
        return
    cur = d
    for k in path[:-1]:
        cur = cur.setdefault(k, {})
    cur[path[-1]] = val

set_key(obj, ['channels','telegram','botToken'], os.environ.get('TELEGRAM_BOT_TOKEN'))
set_key(obj, ['tools','web','search','apiKey'], os.environ.get('BRAVE_API_KEY'))
set_key(obj, ['gateway','auth','token'], os.environ.get('GATEWAY_TOKEN'))

path.write_text(json.dumps(obj, indent=2) + "\n")
PY

# Optional: restart gateway if running
if systemctl --user is-active --quiet clawdbot-gateway; then
  systemctl --user restart clawdbot-gateway
fi

echo "moltbot auth complete"
